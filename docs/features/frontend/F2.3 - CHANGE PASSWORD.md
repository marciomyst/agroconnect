# F2.3 ‚Äî Change Password (Security)

## üéØ Objetivo

Entregar uma tela de **Security / Change Password** que permita ao usu√°rio autenticado:

* alterar a pr√≥pria senha de forma segura
* receber feedback claro e imediato em caso de erro
* confirmar visualmente o sucesso da opera√ß√£o

A F2.3 fecha o ciclo de **seguran√ßa b√°sica de conta** no frontend, complementando o Login (F2.1) e o User Profile (F2.2).

---

## üß† Contexto

Infra j√° dispon√≠vel:

* Autentica√ß√£o baseada em token (`AuthTokenService`)
* Contexto do usu√°rio autenticado (`CurrentUserStore`)
* Interceptor global de erros (F1.1)
* Guards refinados (F1.2)
* Layout base com navega√ß√£o global (F1.3)

Backend:

* J√° existe uma opera√ß√£o de **Change User Password** na camada de Application
* Endpoint t√≠pico:

  ```
  POST /api/auth/change-password
  ```

  ```json
  {
    "currentPassword": "string",
    "newPassword": "string"
  }
  ```

Observa√ß√µes importantes:

* A troca de senha √© **global ao usu√°rio**
* N√£o depende de organiza√ß√£o ativa
* N√£o deve causar logout autom√°tico, salvo decis√£o expl√≠cita de seguran√ßa (fora do escopo atual)

---

## üìå Escopo Funcional

### 1. Tela de Security / Change Password

Criar uma tela acess√≠vel por rota protegida, por exemplo:

* `/security`
* ou `/settings/security`

Conte√∫do m√≠nimo da tela:

* Campo: **Current password**
* Campo: **New password**
* Campo: **Confirm new password**
* Bot√£o: **Change password**

---

### 2. Formul√°rio e Valida√ß√µes

Campos e regras:

| Campo             | Tipo  | Regras                                      |
| ----------------- | ----- | ------------------------------------------- |
| `currentPassword` | senha | obrigat√≥rio                                 |
| `newPassword`     | senha | obrigat√≥rio                                 |
| `confirmPassword` | senha | obrigat√≥rio, deve ser igual a `newPassword` |

Valida√ß√µes obrigat√≥rias:

* Todos os campos s√£o obrigat√≥rios
* `confirmPassword` deve ser exatamente igual a `newPassword`

Valida√ß√µes recomendadas (se aplic√°vel):

* Tamanho m√≠nimo da nova senha (ex.: 8 caracteres)
* Outras regras de complexidade, se o backend exigir

Comportamento:

* Formul√°rio inv√°lido bloqueia o submit
* Campos inv√°lidos exibem mensagens claras
* Ao tentar submeter inv√°lido, todos os campos devem ser marcados como `touched`

---

### 3. Fluxo de Altera√ß√£o de Senha

Fluxo esperado:

1. Usu√°rio acessa a tela de Security
2. Preenche os tr√™s campos do formul√°rio
3. Clica em **Change password**
4. Frontend valida o formul√°rio
5. Se v√°lido:

   * envia `currentPassword` e `newPassword` para o backend
   * entra em estado de loading
6. Em caso de sucesso:

   * exibe mensagem de confirma√ß√£o
   * limpa os campos do formul√°rio
7. Em caso de erro:

   * exibe mensagem apropriada
   * mant√©m o formul√°rio utiliz√°vel

---

### 4. Tratamento de Erros

Casos m√≠nimos que devem ser tratados explicitamente:

| Situa√ß√£o              | Mensagem sugerida                                                                      |
| --------------------- | -------------------------------------------------------------------------------------- |
| Senha atual incorreta | ‚ÄúCurrent password is incorrect.‚Äù                                                       |
| Nova senha inv√°lida   | Mensagem retornada pelo backend (ex.: ‚ÄúPassword does not meet security requirements.‚Äù) |
| Erro de rede / 5xx    | ‚ÄúWe couldn‚Äôt update your password. Please try again in a moment.‚Äù                      |

Regras:

* Nunca exibir mensagens t√©cnicas ou stack trace
* N√£o expor detalhes internos do backend
* Manter a linguagem clara, direta e amig√°vel

---

## üåä Fluxos de Uso

### Fluxo A ‚Äî Sucesso

1. Usu√°rio autenticado acessa `/security`
2. Preenche corretamente os campos
3. Submete o formul√°rio
4. Backend confirma a altera√ß√£o
5. Tela exibe mensagem de sucesso
6. Campos s√£o limpos
7. Usu√°rio permanece autenticado

---

### Fluxo B ‚Äî Senha atual incorreta

1. Usu√°rio informa senha atual errada
2. Backend retorna erro de valida√ß√£o
3. Tela exibe mensagem espec√≠fica
4. Usu√°rio pode tentar novamente sem sair da tela

---

### Fluxo C ‚Äî Erro de infraestrutura

1. Durante o submit ocorre erro de rede/servidor
2. Tela exibe mensagem gen√©rica
3. Formul√°rio continua dispon√≠vel para nova tentativa

---

## üé® UX / UI Guidelines

* Se√ß√£o claramente identificada como **Security**
* Visual simples, focado em seguran√ßa
* Mensagens de erro e sucesso claramente destacadas
* Bot√£o de submit:

  * desabilitado quando formul√°rio inv√°lido
  * desabilitado durante loading
* Campos de senha nunca exibem valores em claro ap√≥s submit

---

## üß± Componentes Envolvidos

* Componente:

  * `src/app/security/change-password.component.ts`
  * `change-password.component.html`
  * `change-password.component.scss`
* Servi√ßos:

  * `AuthApiService` ou `UserSecurityApiService`
* Stores:

  * apenas leitura de `CurrentUserStore`
* Guards:

  * `authCanMatch` (obrigat√≥rio)
  * **n√£o usar** `hasActiveOrganizationCanMatch`

---

## ‚úÖ Crit√©rios de Aceite (mais espec√≠ficos)

**Formul√°rio**

* [ ] N√£o √© poss√≠vel submeter com campos vazios
* [ ] `confirmPassword` deve ser igual a `newPassword`
* [ ] Erros de valida√ß√£o aparecem de forma clara por campo

**Sucesso**

* [ ] Mensagem de sucesso √© exibida ap√≥s troca de senha
* [ ] Campos do formul√°rio s√£o limpos
* [ ] Usu√°rio permanece autenticado

**Erros**

* [ ] Senha atual incorreta exibe mensagem espec√≠fica
* [ ] Erros de pol√≠tica de senha exibem mensagem do backend
* [ ] Erros de rede/servidor exibem mensagem gen√©rica

**Autoriza√ß√£o**

* [ ] Usu√°rio n√£o autenticado n√£o acessa a rota (redireciona para `/login`)
* [ ] Tela n√£o depende de organiza√ß√£o ativa

**N√£o regress√£o**

* [ ] Logout manual continua funcionando normalmente
* [ ] Trocar senha n√£o afeta navega√ß√£o ou contexto de organiza√ß√£o