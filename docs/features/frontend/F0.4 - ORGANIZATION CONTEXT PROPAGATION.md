# üß© F0.4 ‚Äî Organization Context Propagation

## üéØ Objetivo

Garantir que **todas as chamadas autenticadas do frontend carreguem explicitamente o contexto da organiza√ß√£o ativa**, permitindo que o backend execute **autoriza√ß√£o, escopo e regras de dom√≠nio corretamente** sem infer√™ncia impl√≠cita.

Esta feature **fecha a Fase 0 do frontend**, conectando o `ActiveOrganizationStore` √† comunica√ß√£o HTTP.

---

## üß† Contexto

Nas fases anteriores (F0.2 e F0.3), o frontend j√° possui:

* Autentica√ß√£o com token (`AuthTokenService`)
* Contexto do usu√°rio autenticado (`CurrentUserStore`)
* Contexto de organiza√ß√£o ativa (`ActiveOrganizationStore`)
* Guards que impedem acesso a rotas protegidas sem organiza√ß√£o ativa

Entretanto, **at√© este ponto, o contexto organizacional existe apenas no frontend**, n√£o sendo propagado para o backend nas requisi√ß√µes HTTP.

Isso cria um ‚Äúvazio de contexto‚Äù onde:

* O backend n√£o sabe **em nome de qual organiza√ß√£o** a opera√ß√£o est√° sendo executada
* Regras de autoriza√ß√£o dependem de infer√™ncia indireta
* O modelo n√£o escala corretamente para m√∫ltiplas organiza√ß√µes por usu√°rio

A F0.4 resolve esse problema de forma expl√≠cita e padronizada.

---

## üìå Escopo

### Inclu√≠do

* Propaga√ß√£o autom√°tica do contexto da organiza√ß√£o ativa em **todas as requisi√ß√µes autenticadas**
* Padroniza√ß√£o dos headers HTTP de contexto organizacional
* Integra√ß√£o direta com `ActiveOrganizationStore`
* Comportamento seguro quando n√£o h√° organiza√ß√£o ativa

### Fora do escopo

* Valida√ß√£o do header no backend
* Regras de autoriza√ß√£o baseadas em organiza√ß√£o
* Multi-organiza√ß√£o em uma √∫nica requisi√ß√£o
* Mudan√ßas visuais de UX

---

## üîó Headers de Contexto Organizacional

### Header Principal

| Header              | Descri√ß√£o                                 |
| ------------------- | ----------------------------------------- |
| `X-Organization-Id` | Identificador da organiza√ß√£o ativa (GUID) |

### Headers Opcionais (extens√≠veis)

> Estes headers **n√£o s√£o obrigat√≥rios nesta fase**, mas o frontend pode ser facilmente estendido para inclu√≠-los.

| Header                | Descri√ß√£o                               |
| --------------------- | --------------------------------------- |
| `X-Organization-Type` | Tipo da organiza√ß√£o (`Seller` / `Farm`) |

---

## üîÑ Fluxo de Execu√ß√£o

1. Usu√°rio realiza login
2. `CurrentUserStore` √© carregado com:

   * usu√°rio
   * organiza√ß√µes
3. Usu√°rio seleciona uma organiza√ß√£o
4. `ActiveOrganizationStore` guarda:

   * `organizationId`
   * `organizationType`
5. Em cada chamada HTTP autenticada:

   * `AuthTokenInterceptor`:

     * adiciona `Authorization: Bearer <token>`
     * l√™ `ActiveOrganizationStore`
     * adiciona `X-Organization-Id` ao request
6. Backend recebe:

   * identidade do usu√°rio (token)
   * contexto organizacional expl√≠cito (header)

---

## üß± Componentes Envolvidos

### Interceptor

**Arquivo**

```
src/app/core/auth/auth-token.interceptor.ts
```

**Responsabilidades**

* Interceptar requisi√ß√µes para `/api/**`
* Anexar token JWT
* Anexar headers de contexto organizacional quando dispon√≠veis

---

## üß© Comportamento Esperado

### Quando h√° organiza√ß√£o ativa

* Header `X-Organization-Id` √© enviado em todas as requisi√ß√µes autenticadas
* Backend pode assumir:

  * escopo organizacional expl√≠cito
  * autoriza√ß√£o baseada em membership

### Quando N√ÉO h√° organiza√ß√£o ativa

* Nenhum header de organiza√ß√£o √© enviado
* Requisi√ß√µes que exigem organiza√ß√£o:

  * j√° s√£o bloqueadas por guards (`hasActiveOrganizationCanMatch`)
* Requisi√ß√µes globais (ex.: `/auth/me`) continuam funcionando

---

## üß™ Crit√©rios de Aceite

* [ ] Requisi√ß√µes autenticadas incluem `Authorization: Bearer <token>`
* [ ] Requisi√ß√µes autenticadas incluem `X-Organization-Id` quando houver organiza√ß√£o ativa
* [ ] Nenhum header organizacional √© enviado quando n√£o h√° organiza√ß√£o ativa
* [ ] Logout limpa token **e** organiza√ß√£o ativa
* [ ] Troca de organiza√ß√£o reflete imediatamente nas pr√≥ximas requisi√ß√µes
* [ ] N√£o h√° depend√™ncia direta entre componentes de UI e headers HTTP

---

## üß≠ Decis√µes Arquiteturais

* **Headers HTTP** foram escolhidos em vez de:

  * query strings (poluem URLs)
  * claims no token (token ficaria din√¢mico e fr√°gil)
* O contexto organizacional:

  * √© **expl√≠cito**
  * √© **mut√°vel durante a sess√£o**
  * n√£o viola princ√≠pios de stateless do backend
* O frontend **n√£o tenta inferir autoriza√ß√£o**, apenas declara contexto