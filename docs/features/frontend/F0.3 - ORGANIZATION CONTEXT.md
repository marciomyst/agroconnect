# ğŸ§© F-Front 0.3 â€” Organization Context (Active Org)

## ğŸ¯ Objetivo

Introduzir o **conceito de OrganizaÃ§Ã£o Ativa (Active Organization Context)** no frontend, permitindo que o sistema:

* Trabalhe corretamente com usuÃ¡rios que pertencem a **mÃºltiplas organizaÃ§Ãµes**
* Diferencie contexto de **Farm** e **Seller** de forma explÃ­cita
* Centralize a seleÃ§Ã£o e persistÃªncia da organizaÃ§Ã£o ativa
* Garanta que telas, guards e chamadas de API operem sempre dentro de um **contexto organizacional claro**

Este F0.3 **nÃ£o entrega funcionalidades de negÃ³cio**, apenas a **infraestrutura de contexto organizacional**, essencial para F1.x em diante.

---

## ğŸ§­ MotivaÃ§Ã£o

ApÃ³s o **F-Front 0.2**, o frontend jÃ¡ possui:

* AutenticaÃ§Ã£o funcional
* JWT + interceptor
* `CurrentUserContext` carregado do backend
* InformaÃ§Ã£o de organizaÃ§Ãµes e roles por usuÃ¡rio

Entretanto, **o backend trabalha sempre com uma organizaÃ§Ã£o especÃ­fica** (Farm ou Seller), enquanto o frontend ainda nÃ£o tem um conceito explÃ­cito de:

> â€œQual organizaÃ§Ã£o este usuÃ¡rio estÃ¡ usando agora?â€

Sem isso:

* O frontend nÃ£o sabe qual Farm comprar
* O Seller nÃ£o sabe qual organizaÃ§Ã£o estÃ¡ cadastrando ofertas
* Guards ficam ambÃ­guos
* Chamadas de API precisam receber `organizationId` â€œno improvisoâ€

O F-Front 0.3 resolve esse problema de forma **centralizada, previsÃ­vel e reutilizÃ¡vel**.

---

## ğŸ“Œ Escopo

### Inclui

* Store de **OrganizaÃ§Ã£o Ativa** (ActiveOrgStore)
* SeleÃ§Ã£o explÃ­cita de organizaÃ§Ã£o (Farm ou Seller)
* PersistÃªncia da organizaÃ§Ã£o ativa
* IntegraÃ§Ã£o com `CurrentUserStore`
* Guards baseados em organizaÃ§Ã£o ativa
* Infraestrutura para anexar o contexto organizacional Ã s chamadas de API

### NÃ£o inclui

* UI final do seletor (apenas estrutura mÃ­nima)
* ValidaÃ§Ãµes de negÃ³cio especÃ­ficas
* AutorizaÃ§Ã£o fina por feature
* Regras de marketplace, pedidos ou faturamento

---

## ğŸ§© Conceito de OrganizaÃ§Ã£o Ativa

### DefiniÃ§Ã£o

A **OrganizaÃ§Ã£o Ativa** representa:

* Uma **Farm** ou **Seller**
* Para a qual o usuÃ¡rio possui **membership vÃ¡lido**
* Que serÃ¡ usada como **contexto implÃ­cito** em:

  * NavegaÃ§Ã£o
  * Guards
  * Chamadas de API
  * OperaÃ§Ãµes de negÃ³cio futuras

Somente **uma organizaÃ§Ã£o pode estar ativa por vez**.

---

## ğŸ§  ActiveOrganizationStore (Signals)

### Responsabilidade

Centralizar o estado da organizaÃ§Ã£o ativa, incluindo:

* `organizationId`
* `organizationType` (Farm | Seller)
* `roles` do usuÃ¡rio naquela organizaÃ§Ã£o
* Metadados bÃ¡sicos (nome, etc.)

### CaracterÃ­sticas

* Implementado com **Angular Signals**
* Totalmente desacoplado de UI
* Depende apenas do `CurrentUserStore`
* PersistÃªncia local (ex.: `localStorage`)

### OperaÃ§Ãµes mÃ­nimas

* `setActiveOrganization(org)`
* `clear()`
* `loadFromStorage()`
* `hasActiveOrganization()`

---

## ğŸ”— IntegraÃ§Ã£o com CurrentUserContext

Regras obrigatÃ³rias:

1. A organizaÃ§Ã£o ativa **deve existir** dentro do `CurrentUserContext`
2. Ao trocar de usuÃ¡rio (logout/login):

   * OrganizaÃ§Ã£o ativa deve ser limpa
3. Se o usuÃ¡rio tiver **apenas uma organizaÃ§Ã£o**:

   * Ela pode ser selecionada automaticamente
4. Se o usuÃ¡rio tiver **mÃºltiplas organizaÃ§Ãµes**:

   * O sistema deve exigir seleÃ§Ã£o explÃ­cita

---

## ğŸš¦ Guards Baseados em OrganizaÃ§Ã£o

### hasActiveOrganizationCanMatch

ResponsÃ¡vel por:

* Verificar se existe organizaÃ§Ã£o ativa
* Bloquear acesso a rotas que exigem contexto organizacional
* Redirecionar para tela de seleÃ§Ã£o (futura) se necessÃ¡rio

### IntegraÃ§Ã£o com roleCanMatch

* `roleCanMatch` deve considerar:

  * Papel do usuÃ¡rio **na organizaÃ§Ã£o ativa**
  * NÃ£o apenas a existÃªncia do papel em qualquer organizaÃ§Ã£o

> Essa mudanÃ§a refina a seguranÃ§a introduzida no F0.2.

---

## ğŸŒ IntegraÃ§Ã£o com API (Infraestrutura)

O F-Front 0.3 prepara o frontend para:

* Enviar `organizationId` explicitamente:

  * Em headers customizados (ex.: `X-Organization-Id`), ou
  * Em parÃ¢metros/payloads (decisÃ£o futura)
* Garantir que toda chamada de negÃ³cio tenha contexto organizacional

> A decisÃ£o exata de transporte (header vs payload) pode ser tomada em features futuras, mas a **infraestrutura deve existir**.

---

## ğŸ–¥ï¸ UI de SeleÃ§Ã£o (mÃ­nima)

Este F0.3 permite apenas:

* Um componente mÃ­nimo de seleÃ§Ã£o (ex.: lista simples ou dropdown)
* Sem design final
* Sem refinamento de UX

O objetivo Ã© **desbloquear o fluxo**, nÃ£o finalizar a experiÃªncia.

---

## ğŸ“ Regras Arquiteturais

1. Nenhuma feature assume organizaÃ§Ã£o implicitamente
2. Guards nunca inventam organizaÃ§Ã£o ativa
3. ActiveOrganizationStore nÃ£o acessa API diretamente
4. CurrentUserStore Ã© sempre a fonte de memberships vÃ¡lidos
5. Logout sempre limpa organizaÃ§Ã£o ativa
6. Contexto organizacional Ã© transversal a Farmer/Seller/Admin

---

## ğŸš« Fora de Escopo

* UI final do seletor de organizaÃ§Ã£o
* PersistÃªncia em backend
* Auditoria de troca de organizaÃ§Ã£o
* AutorizaÃ§Ã£o por feature fina
* Multi-organizaÃ§Ã£o simultÃ¢nea

---

## ğŸ—‚ï¸ Estrutura de Arquivos (ReferÃªncia)

```text
src/app/core/
 â”œâ”€â”€ organization/
 â”‚    â”œâ”€â”€ active-organization.store.ts
 â”‚    â”œâ”€â”€ organization.model.ts
 â”‚    â””â”€â”€ guards/
 â”‚         â””â”€â”€ has-active-organization.can-match.ts
```

---

## âœ… Checklist de ImplementaÃ§Ã£o

### Store

* [ ] ActiveOrganizationStore (Signals)
* [ ] PersistÃªncia local
* [ ] IntegraÃ§Ã£o com CurrentUserStore

### Guards

* [ ] hasActiveOrganizationCanMatch
* [ ] Ajuste no roleCanMatch para usar org ativa

### Infra

* [ ] Preparar propagaÃ§Ã£o do organizationId (infra)

### UX mÃ­nima

* [ ] Componente simples de seleÃ§Ã£o de organizaÃ§Ã£o