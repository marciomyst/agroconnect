# üß© F1.2 ‚Äî Guards & Navigation Flow Refinement

## üéØ Objetivo

Garantir que a navega√ß√£o seja **previs√≠vel, segura e coerente**, considerando:

* estado de autentica√ß√£o do usu√°rio
* exist√™ncia de organiza√ß√£o ativa quando exigida
* papel (role) do usu√°rio para acessar um m√≥dulo/rota

Reduzindo comportamentos inesperados, redirects em loop e telas quebradas.

---

## üß† Contexto Atual

Guards existentes:

* `auth-can-match.guard.ts`
* `role-can-match.guard.ts`
* `has-active-organization.can-match.ts`

Rotas usam combina√ß√µes do tipo:

```ts
canMatch: [authCanMatch, hasActiveOrganizationCanMatch, roleCanMatch('Seller')]
```

Pontos a refinar:

* ordem de execu√ß√£o (auth ‚Üí org ‚Üí role)
* padroniza√ß√£o dos redirecionamentos
* clareza sobre quais rotas exigem ou n√£o organiza√ß√£o ativa

---

## üìå Escopo Detalhado

1. **Revisar `authCanMatch`**

   * Responsabilidades:

     * verificar se h√° token via `AuthTokenService`.
     * se n√£o houver token ‚Üí redirecionar para `/login` e bloquear rota.
     * se houver token mas `CurrentUserStore` n√£o estiver carregado ‚Üí chamar `loadFromApi()`.
     * em caso de falha ao carregar (`401` ou erro grave) ‚Üí redirecionar para `/login`.
   * Resultado:

     * S√≥ permite seguir para pr√≥ximo guard se usu√°rio est√° autenticado e contexto b√°sico carregado.

2. **Revisar `hasActiveOrganizationCanMatch`**

   * Responsabilidades:

     * verificar se a rota **exige** organiza√ß√£o ativa (ex.: m√≥dulos `seller` e `farmer`).
     * se n√£o houver `activeOrganization`:

       * tentar restaurar de `localStorage` (via efeito existente em `ActiveOrganizationStore`).
       * se ainda assim n√£o houver ‚Üí redirecionar para `/select-organization`.
   * Importante:

     * s√≥ deve ser aplicado em rotas onde o contexto de organiza√ß√£o √© obrigat√≥rio.
     * n√£o deve ser usado para rotas globais (ex.: `/admin` se admin n√£o for org-bound).

3. **Revisar `roleCanMatch`**

   * Responsabilidades:

     * verificar se o usu√°rio possui o papel exigido **no contexto da organiza√ß√£o ativa**.
     * se n√£o possuir:

       * negar acesso e, opcionalmente, redirecionar para `/access-denied`.
   * Decis√£o:

     * manter o guard simples: retornar `false` e opcionalmente usar `Router` para `/access-denied`.

4. **Padronizar ordem de guards nas rotas**

   * Para rotas org-bound:

     ```ts
     canMatch: [authCanMatch, hasActiveOrganizationCanMatch, roleCanMatch('Seller')]
     ```
   * Para rotas apenas auth-bound (sem org):

     ```ts
     canMatch: [authCanMatch, roleCanMatch('Admin')]
     ```

5. **Evitar m√∫ltiplos redirects em cascata**

   * Garantir que cada guard s√≥ fa√ßa **um tipo de decis√£o**:

     * `authCanMatch` ‚Üí autenticado ou `/login`.
     * `hasActiveOrganizationCanMatch` ‚Üí org ativa ou `/select-organization`.
     * `roleCanMatch` ‚Üí possui role ou `/access-denied`.
   * N√£o encadear redirecionamentos dentro de cada um.

---

## üåä Fluxos de Navega√ß√£o

1. **Usu√°rio n√£o autenticado tenta acessar rota protegida**

   * `authCanMatch` detecta aus√™ncia de token ‚Üí `/login`.
   * `hasActiveOrganizationCanMatch` e `roleCanMatch` nem s√£o executados.

2. **Usu√°rio autenticado sem organiza√ß√£o ativa tenta acessar rota org-bound**

   * `authCanMatch` permite (usu√°rio autenticado).
   * `hasActiveOrganizationCanMatch` detecta aus√™ncia de org ‚Üí `/select-organization`.
   * `roleCanMatch` n√£o √© executado.

3. **Usu√°rio autenticado com org ativa, mas sem role exigido**

   * `authCanMatch` permite.
   * `hasActiveOrganizationCanMatch` permite.
   * `roleCanMatch('Seller')` falha ‚Üí `/access-denied`.

---

## ‚úÖ Crit√©rios de Aceite (mais espec√≠ficos)

**Auth**

* [ ] Acessar rota protegida **sem token** sempre resulta em:

  * [ ] bloqueio da rota (`false`)
  * [ ] navega√ß√£o para `/login` (uma √∫nica vez)

* [ ] Acessar rota protegida **com token**, mas sem contexto carregado:

  * [ ] dispara `CurrentUserStore.loadFromApi()`
  * [ ] se sucesso, permite continuar
  * [ ] se falha (401), limpa sess√£o e redireciona para `/login`

**Organiza√ß√£o ativa**

* [ ] Acessar rota org-bound (ex.: `/seller/**`, `/farmer/**`) **sem org ativa**:

  * [ ] tenta restaurar de storage
  * [ ] se n√£o restaurar, redireciona para `/select-organization`
  * [ ] n√£o executa `roleCanMatch`

* [ ] Acessar rota **n√£o org-bound** (ex.: `/admin/**` se for global):

  * [ ] n√£o exige `hasActiveOrganizationCanMatch`
  * [ ] n√£o redireciona para `/select-organization`

**Role**

* [ ] Acessar rota com org ativa mas role insuficiente:

  * [ ] nega acesso de forma expl√≠cita
  * [ ] redireciona para `/access-denied` (ou alternativa definida)
  * [ ] n√£o altera token nem stores

**Ordem e estabilidade**

* [ ] Ordem efetiva de decis√£o √© sempre: `authCanMatch` ‚Üí `hasActiveOrganizationCanMatch` ‚Üí `roleCanMatch`.
* [ ] N√£o h√° loops de redirect entre `/login` e rotas protegidas.
* [ ] N√£o h√° m√∫ltiplas navega√ß√µes concorrentes disparadas pelos guards.

**Verifica√ß√£o manual m√≠nima**

* [ ] Abrir diretamente `/seller` em aba an√¥nima ‚Üí cai em `/login`.
* [ ] Ap√≥s login com m√∫ltiplas orgs, tentar `/seller` sem escolher org ‚Üí vai para `/select-organization`.
