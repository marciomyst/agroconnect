# ğŸ“˜ F2.3 â€” GrantSellerMembership

## ğŸ¯ Objetivo

Criar a **feature de concessÃ£o de Membership em Seller**, permitindo que um **User autorizado** conceda um papel a **outro User** dentro de uma **Seller existente**.

Responsabilidades:

* Criar um novo `SellerMembership`
* Atribuir um `SellerRole` vÃ¡lido
* Garantir autorizaÃ§Ã£o baseada em **Membership + Role**
* Disparar o evento de domÃ­nio `SellerMembershipGranted`

NÃ£o Ã© responsabilidade desta feature:

* Criar Sellers
* Criar Users
* Autenticar usuÃ¡rios
* Criar eventos novos

---

## ğŸ“ Estrutura de pastas / namespaces

### Domain (reuso)

```text
AgroConnect.Domain
 â””â”€â”€ Memberships
     â”œâ”€â”€ SellerMembership.cs
     â””â”€â”€ SellerRole.cs
```

> O aggregate `SellerMembership` e o enum `SellerRole` jÃ¡ existem (F2.1).

Namespaces:

```csharp
namespace AgroConnect.Domain.Memberships;
```

---

### Application

```text
AgroConnect.Application
 â””â”€â”€ Features
     â””â”€â”€ Sellers
         â””â”€â”€ GrantSellerMembership
             â”œâ”€â”€ GrantSellerMembershipCommand.cs
             â”œâ”€â”€ GrantSellerMembershipResult.cs
             â”œâ”€â”€ GrantSellerMembershipHandler.cs
             â””â”€â”€ GrantSellerMembershipValidator.cs
```

---

### Api

```text
AgroConnect.Api
 â””â”€â”€ Features
     â””â”€â”€ Sellers
         â””â”€â”€ GrantSellerMembership
             â”œâ”€â”€ GrantSellerMembershipEndpoint.cs
             â””â”€â”€ GrantSellerMembershipHttpRequest.cs
```

---

## 1. Aggregate `SellerMembership` (reutilizado)

### Objetivo

Representar o **vÃ­nculo entre um User e uma Seller**, com um papel especÃ­fico.

### Regras relevantes para o F2.3

* Um `SellerMembership` representa **um papel Ãºnico**
* Aggregate nÃ£o referencia `Seller` nem `User` diretamente (apenas IDs)
* O evento `SellerMembershipGranted` Ã© disparado na criaÃ§Ã£o

---

## 2. Command `GrantSellerMembership`

### Objetivo

Expressar a intenÃ§Ã£o de **conceder um papel em uma Seller a um User**.

### Dados

* `ExecutorUserId` â€” User autenticado
* `SellerId`
* `TargetUserId`
* `Role` (`SellerRole`)

---

## 3. Handler `GrantSellerMembershipHandler`

### Responsabilidade

Executar a concessÃ£o de Membership garantindo **autorizaÃ§Ã£o, consistÃªncia e atomicidade**.

### Fluxo lÃ³gico

1. Validar Command
2. Garantir que a Seller existe
3. Garantir que o Target User existe
4. Carregar Memberships do ExecutorUser na Seller
5. Validar autorizaÃ§Ã£o:

   * **Apenas `SellerRole.Owner` pode conceder Membership**
6. Verificar duplicidade de Membership
7. Criar `SellerMembership`
8. Persistir via write repository
9. Commit da Unit of Work
10. Retornar `SellerMembershipId`

---

## 4. ValidaÃ§Ã£o

Regras mÃ­nimas:

* `ExecutorUserId` â‰  vazio
* `SellerId` â‰  vazio
* `TargetUserId` â‰  vazio
* `Role` vÃ¡lido

---

## 5. Endpoint HTTP

```text
POST /api/sellers/{sellerId}/memberships
```

### Status HTTP

* `201 Created`
* `400 Bad Request`
* `401 Unauthorized`
* `403 Forbidden`
* `404 Not Found`
* `409 Conflict`

---

## 6. Evento de DomÃ­nio

Evento utilizado (jÃ¡ existente):

```text
SellerMembershipGranted
```

Payload mÃ­nimo:

* SellerId
* UserId
* Role

---

## 7. Regras explÃ­citas

1. AutorizaÃ§Ã£o baseada em **Membership + Role**
2. JWT **nÃ£o carrega papÃ©is**
3. Apenas Aggregates levantam eventos
4. PersistÃªncia apenas via write model

---

---

# ğŸ“˜ F2.4 â€” GrantFarmMembership

## ğŸ¯ Objetivo

Criar a **feature de concessÃ£o de Membership em Farm**, permitindo que um **User autorizado** conceda um papel a **outro User** dentro de uma **Farm existente**.

Responsabilidades:

* Criar um novo `FarmMembership`
* Atribuir um `FarmRole` vÃ¡lido
* Garantir autorizaÃ§Ã£o baseada em Membership
* Disparar o evento de domÃ­nio `FarmMembershipGranted`

NÃ£o Ã© responsabilidade desta feature:

* Criar Farms
* Criar Users
* Autenticar usuÃ¡rios
* Criar eventos novos

---

## ğŸ“ Estrutura de pastas / namespaces

### Domain (reuso)

```text
AgroConnect.Domain
 â””â”€â”€ Memberships
     â”œâ”€â”€ FarmMembership.cs
     â””â”€â”€ FarmRole.cs
```

> O aggregate `FarmMembership` e o enum `FarmRole` jÃ¡ existem (F2.2).

Namespaces:

```csharp
namespace AgroConnect.Domain.Memberships;
```

---

### Application

```text
AgroConnect.Application
 â””â”€â”€ Features
     â””â”€â”€ Farms
         â””â”€â”€ GrantFarmMembership
             â”œâ”€â”€ GrantFarmMembershipCommand.cs
             â”œâ”€â”€ GrantFarmMembershipResult.cs
             â”œâ”€â”€ GrantFarmMembershipHandler.cs
             â””â”€â”€ GrantFarmMembershipValidator.cs
```

---

### Api

```text
AgroConnect.Api
 â””â”€â”€ Features
     â””â”€â”€ Farms
         â””â”€â”€ GrantFarmMembership
             â”œâ”€â”€ GrantFarmMembershipEndpoint.cs
             â””â”€â”€ GrantFarmMembershipHttpRequest.cs
```

---

## 1. Aggregate `FarmMembership` (reutilizado)

### Objetivo

Representar o **vÃ­nculo entre um User e uma Farm**, com um papel especÃ­fico.

### Regras relevantes para o F2.4

* Um `FarmMembership` representa **um papel Ãºnico**
* Aggregate nÃ£o referencia `Farm` nem `User`
* O evento `FarmMembershipGranted` Ã© disparado na criaÃ§Ã£o

---

## 2. Command `GrantFarmMembership`

### Objetivo

Expressar a intenÃ§Ã£o de **conceder um papel em uma Farm a um User**.

### Dados

* `ExecutorUserId`
* `FarmId`
* `TargetUserId`
* `Role` (`FarmRole`)

---

## 3. Handler `GrantFarmMembershipHandler`

### Responsabilidade

Executar a concessÃ£o de Membership garantindo **autorizaÃ§Ã£o, consistÃªncia e atomicidade**.

### Fluxo lÃ³gico

1. Validar Command
2. Garantir que a Farm existe
3. Garantir que o Target User existe
4. Carregar Memberships do ExecutorUser na Farm
5. Validar autorizaÃ§Ã£o:

   * **Apenas `FarmRole.Owner` pode conceder Membership**
6. Verificar duplicidade de Membership
7. Criar `FarmMembership`
8. Persistir via write repository
9. Commit da Unit of Work
10. Retornar `FarmMembershipId`

---

## 4. ValidaÃ§Ã£o

Regras mÃ­nimas:

* `ExecutorUserId` â‰  vazio
* `FarmId` â‰  vazio
* `TargetUserId` â‰  vazio
* `Role` vÃ¡lido

---

## 5. Endpoint HTTP

```text
POST /api/farms/{farmId}/memberships
```

### Status HTTP

* `201 Created`
* `400 Bad Request`
* `401 Unauthorized`
* `403 Forbidden`
* `404 Not Found`
* `409 Conflict`

---

## 6. Evento de DomÃ­nio

Evento utilizado (jÃ¡ existente):

```text
FarmMembershipGranted
```

Payload mÃ­nimo:

* FarmId
* UserId
* Role

---

## 7. Regras explÃ­citas

1. AutorizaÃ§Ã£o baseada em **Membership + Role**
2. JWT **nÃ£o carrega papÃ©is**
3. Apenas Aggregates levantam eventos
4. PersistÃªncia apenas via write model

---

## 8. ObservaÃ§Ã£o Final de GovernanÃ§a

Os F2.3 e F2.4 sÃ£o **simÃ©tricos por design** e consolidam:

* o conceito de Membership como nÃºcleo da autorizaÃ§Ã£o
* a separaÃ§Ã£o entre identidade (User) e contexto organizacional
* a base para autorizaÃ§Ã£o em **Orders, Products, CollectiveDeals**
