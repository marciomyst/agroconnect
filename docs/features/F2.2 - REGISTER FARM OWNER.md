## üéØ Objetivo do F2.2 ‚Äî RegisterFarmWithOwner

Criar a **feature de cadastro de Farm (Produtor Rural) com Owner**, respons√°vel por:

* Registrar uma nova **Farm**
* Criar o v√≠nculo inicial entre um **User** e a **Farm**
* Atribuir o papel **FarmRole.Owner**
* Garantir invariantes de dom√≠nio
* Disparar eventos de dom√≠nio oficiais

Sem:

* violar CQRS
* acoplar dom√≠nio a infraestrutura
* criar conceitos fora da Linguagem Ub√≠qua
* criar eventos n√£o catalogados

---

## üìÅ Estrutura de pastas / namespaces

### Domain

Em `Agronomia.Domain`:

```text
Agronomia.Domain
 ‚îî‚îÄ‚îÄ Organizations
     ‚îî‚îÄ‚îÄ Farm.cs

Agronomia.Domain
 ‚îî‚îÄ‚îÄ Memberships
     ‚îú‚îÄ‚îÄ FarmMembership.cs
     ‚îî‚îÄ‚îÄ FarmRole.cs
```

Namespaces sugeridos:

```csharp
namespace Agronomia.Domain.Organizations;
namespace Agronomia.Domain.Memberships;
```

---

### Application

Em `Agronomia.Application`:

```text
Agronomia.Application
 ‚îî‚îÄ‚îÄ Features
     ‚îî‚îÄ‚îÄ Farms
         ‚îî‚îÄ‚îÄ RegisterFarmWithOwner
             ‚îú‚îÄ‚îÄ RegisterFarmWithOwnerCommand.cs
             ‚îú‚îÄ‚îÄ RegisterFarmWithOwnerResult.cs
             ‚îú‚îÄ‚îÄ RegisterFarmWithOwnerHandler.cs
             ‚îî‚îÄ‚îÄ RegisterFarmWithOwnerValidator.cs
```

---

### Api

Em `Agronomia.Api`:

```text
Agronomia.Api
 ‚îî‚îÄ‚îÄ Features
     ‚îî‚îÄ‚îÄ Farms
         ‚îî‚îÄ‚îÄ RegisterFarmWithOwner
             ‚îú‚îÄ‚îÄ RegisterFarmWithOwnerEndpoint.cs
             ‚îî‚îÄ‚îÄ RegisterFarmWithOwnerHttpRequest.cs
```

---

## 1. Aggregate `Farm`

### 1.1. Objetivo

Representar a **Farm (Produtor Rural)** dentro do dom√≠nio.

---

### 1.2. Responsabilidades

* Manter identidade da Farm
* Proteger invariantes de cria√ß√£o
* Levantar o evento `FarmRegistered`

---

### 1.3. Propriedades essenciais

* `FarmId` (Guid)
* `TaxId` (CPF ou CNPJ)
* `Name` (nome da fazenda / produtor)

---

### 1.4. Regras de cria√ß√£o

* `TaxId` obrigat√≥rio
* `Name` obrigat√≥rio
* Cria√ß√£o ocorre **exclusivamente via m√©todo de f√°brica**
* Ao ser criada, **sempre** dispara `FarmRegistered`

---

### 1.5. Evento levantado

```text
FarmRegistered
```

Payload m√≠nimo (conforme cat√°logo oficial):

* FarmId
* TaxId

---

## 2. Aggregate `FarmMembership`

### 2.1. Objetivo

Representar o **v√≠nculo entre um User e uma Farm**.

---

### 2.2. Responsabilidades

* Garantir v√≠nculo contextual (User ‚Üî Farm)
* Definir papel do User dentro da Farm
* Levantar o evento `FarmMembershipGranted`

---

### 2.3. Propriedades essenciais

* `FarmMembershipId` (Guid)
* `FarmId` (Guid)
* `UserId` (Guid)
* `Role` (`FarmRole`)

---

### 2.4. Regras de cria√ß√£o

* `FarmId` obrigat√≥rio
* `UserId` obrigat√≥rio
* Papel inicial **sempre** `FarmRole.Owner`
* Cria√ß√£o ocorre via f√°brica
* Dispara `FarmMembershipGranted`

---

### 2.5. Evento levantado

```text
FarmMembershipGranted
```

Payload m√≠nimo:

* FarmId
* UserId
* Role

---

## 3. Enum `FarmRole`

### 3.1. Objetivo

Definir pap√©is poss√≠veis de um User dentro de uma Farm.

---

### 3.2. Valores iniciais (normativos)

```text
Owner
Buyer
```

> Conforme Linguagem Ub√≠qua ‚Äî Agronomia

---

## 4. Command `RegisterFarmWithOwner`

### 4.1. Objetivo

Expressar a **inten√ß√£o de registrar uma Farm** e atribuir o User autenticado como Owner.

---

### 4.2. Dados carregados

* `UserId` ‚Äî identidade vinda do JWT
* `TaxId`
* `Name`

---

### 4.3. Assinatura conceitual

```text
RegisterFarmWithOwnerCommand
```

Retorna:

```text
RegisterFarmWithOwnerResult
```

---

## 5. Handler `RegisterFarmWithOwnerHandler`

### 5.1. Responsabilidade

Orquestrar a cria√ß√£o da Farm e do FarmMembership de forma **at√¥mica**.

---

### 5.2. Fluxo l√≥gico

1. Validar Command
2. Verificar se j√° existe Farm com o mesmo `TaxId`
3. Criar Aggregate `Farm`
4. Criar Aggregate `FarmMembership` com `FarmRole.Owner`
5. Persistir ambos via reposit√≥rios de escrita
6. Commit da Unit of Work
7. Retornar IDs criados

---

### 5.3. Reposit√≥rios envolvidos (write model)

* `IFarmRepository`
* `IFarmMembershipRepository`

---

## 6. Validator `RegisterFarmWithOwnerValidator`

### 6.1. Objetivo

Validar **entrada de dados**, n√£o regras de neg√≥cio complexas.

---

### 6.2. Regras m√≠nimas

* `UserId` ‚â† vazio
* `TaxId` ‚â† null / empty
* `Name` ‚â† null / empty

---

## 7. Endpoint HTTP

### 7.1. Rota

```text
POST /api/farms
```

---

### 7.2. Request HTTP

```text
RegisterFarmWithOwnerHttpRequest
```

Campos:

* `TaxId`
* `Name`

---

### 7.3. Response HTTP

Retorno em caso de sucesso:

* `201 Created`
* `FarmId`
* `FarmMembershipId`

Erros esperados:

* `400` ‚Äî valida√ß√£o
* `409` ‚Äî Farm com `TaxId` j√° existente

---

## 8. Eventos de Dom√≠nio envolvidos

Eventos **j√° existentes e normativos**:

* `FarmRegistered`
* `FarmMembershipGranted`

‚ö†Ô∏è Nenhum evento novo √© criado no F2.2.

---

## 9. Regras expl√≠citas do F2.2

1. Apenas Aggregates levantam eventos
2. `Farm` e `FarmMembership` **n√£o se referenciam diretamente**
3. Autentica√ß√£o **n√£o √© responsabilidade** desta feature
4. Pap√©is **n√£o v√£o no JWT**
5. Persist√™ncia apenas via write model (EF Core)
6. Queries futuras usar√£o Dapper (fora do escopo do F2.2)