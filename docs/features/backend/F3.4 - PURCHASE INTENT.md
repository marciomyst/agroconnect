# ğŸ“„ F3.4 â€” Purchase Intent / Quote Request (Backend)

## ğŸ¯ Objetivo

Implementar o **fluxo de IntenÃ§Ã£o de Compra (Purchase Intent / Quote Request)**, permitindo que um **Farmer manifeste interesse comercial** em uma oferta especÃ­fica de um Seller, sem ainda criar pedido, reserva de estoque ou obrigaÃ§Ã£o financeira.

Esta feature representa o **primeiro artefato transacional** do marketplace, conectando **consulta (F3.3)** com **pedido (F4.x)**.

---

## ğŸ§  Contexto

ApÃ³s a F3.3, a plataforma jÃ¡ permite que o Farmer:

* Navegue pelo marketplace
* Visualize produtos
* Compare ofertas de diferentes Sellers

Entretanto, nÃ£o existe ainda nenhuma forma de o Farmer **agir comercialmente** sobre uma oferta.

A F3.4 introduz um **registro explÃ­cito de intenÃ§Ã£o**, que:

* Gera sinal de demanda para o Seller
* Permite negociaÃ§Ã£o futura
* Serve como base para conversÃ£o em pedido

Sem comprometer:

* Estoque
* PreÃ§o final
* Pagamento

---

## ğŸ“¦ Escopo

### ğŸ“Œ DomÃ­nio

#### Aggregate Root: `PurchaseIntent`

Representa uma **manifestaÃ§Ã£o formal de interesse de compra** feita por um Farmer para uma oferta especÃ­fica de um Seller.

---

### ğŸ“„ Atributos (conceituais)

* `PurchaseIntentId`
* `FarmerId`
* `SellerId`
* `ProductId`
* `SellerProductId`
* `Quantity`
* `Notes` (opcional)
* `Status`
* `RequestedAtUtc`
* `UpdatedAtUtc`

---

### ğŸ“˜ Value Objects

* `PurchaseIntentId`
* `FarmerId`
* `SellerId`
* `ProductId`
* `SellerProductId`
* `Quantity`
* `PurchaseIntentStatus`

---

### ğŸ“ Status Permitidos

```text
Pending    â€” criada pelo Farmer, aguardando aÃ§Ã£o do Seller
Accepted   â€” Seller aceitou a intenÃ§Ã£o
Rejected   â€” Seller rejeitou a intenÃ§Ã£o
Expired    â€” intenÃ§Ã£o expirada automaticamente
```

---

## ğŸ“ Regras de NegÃ³cio

* Apenas usuÃ¡rios em **contexto Farm** podem criar intenÃ§Ãµes
* A intenÃ§Ã£o deve referenciar:

  * Um `Product` existente
  * Um `SellerProduct` ativo
* Quantidade deve ser maior que zero
* IntenÃ§Ãµes:

  * **NÃ£o reservam estoque**
  * **NÃ£o fixam preÃ§o**
  * **NÃ£o geram pedido automaticamente**
* Seller pode apenas **aceitar ou rejeitar**
* IntenÃ§Ãµes podem expirar automaticamente apÃ³s perÃ­odo configurÃ¡vel
* Um Farmer pode criar mÃºltiplas intenÃ§Ãµes para o mesmo produto/Seller

---

## ğŸ—‚ï¸ PersistÃªncia (EF Core)

* Nova tabela: `purchase_intents`
* Chave primÃ¡ria:

  * `PurchaseIntentId`
* Chaves estrangeiras:

  * `FarmerId` â†’ Farms
  * `SellerId` â†’ Sellers
  * `ProductId` â†’ Products
  * `SellerProductId` â†’ SellerProducts
* Ãndices:

  * `FarmerId`
  * `SellerId`
  * `Status`
  * `RequestedAtUtc`

---

## ğŸ”Œ Endpoints

### Criar IntenÃ§Ã£o de Compra

```
POST /api/purchase-intents
```

**Request (exemplo):**

```json
{
  "sellerProductId": "uuid",
  "quantity": 10,
  "notes": "Preciso para aplicaÃ§Ã£o em atÃ© 15 dias"
}
```

**Comportamento:**

* Identifica automaticamente:

  * `FarmerId` a partir da organizaÃ§Ã£o ativa
  * `SellerId` e `ProductId` a partir do `SellerProduct`

---

### Listar IntenÃ§Ãµes do Farmer

```
GET /api/farmers/{farmerId}/purchase-intents
```

* Retorna intenÃ§Ãµes criadas pelo Farmer
* Ordenadas por data (mais recente primeiro)

---

### Listar IntenÃ§Ãµes Recebidas pelo Seller

```
GET /api/sellers/{sellerId}/purchase-intents
```

* Retorna intenÃ§Ãµes pendentes/ativas para o Seller

---

### Atualizar Status da IntenÃ§Ã£o (Seller)

```
PUT /api/purchase-intents/{purchaseIntentId}/status
```

**Request:**

```json
{
  "status": "Accepted"
}
```

---

## ğŸ§© Application Layer

### Commands

* `CreatePurchaseIntentCommand`
* `UpdatePurchaseIntentStatusCommand`

### Queries

* `GetFarmerPurchaseIntentsQuery`
* `GetSellerPurchaseIntentsQuery`

### ValidaÃ§Ãµes

* SellerProduct existe e estÃ¡ ativo
* Quantidade vÃ¡lida
* PermissÃµes corretas por contexto (Farm vs Seller)
* TransiÃ§Ãµes de status vÃ¡lidas

---

## ğŸš« Fora de Escopo

* Pedido
* Carrinho
* Pagamento
* Reserva de estoque
* CÃ¡lculo de impostos
* NegociaÃ§Ã£o em tempo real
* Upload de documentos (receita agronÃ´mica)

---

## âœ… CritÃ©rios de Aceite

* Farmer consegue criar uma intenÃ§Ã£o de compra
* Seller consegue visualizar intenÃ§Ãµes recebidas
* Seller consegue aceitar ou rejeitar
* Status Ã© atualizado corretamente
* Nenhuma alteraÃ§Ã£o ocorre em estoque ou preÃ§o
* Migration criada e aplicada corretamente
* CÃ³digo segue DDD + Vertical Slice
* Nenhuma duplicaÃ§Ã£o de lÃ³gica do Marketplace

---

## ğŸ§­ ObservaÃ§Ãµes TÃ©cnicas

* `PurchaseIntent` Ã© o **Ãºltimo aggregate da Fase 3**
* NÃ£o deve haver conversÃ£o automÃ¡tica para pedido
* Eventos de domÃ­nio podem ser preparados (ex.: `PurchaseIntentCreated`)
* Este aggregate serÃ¡ **consumido diretamente pela F4.x**
