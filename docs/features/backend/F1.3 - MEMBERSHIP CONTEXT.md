# üß© F1.3 ‚Äî Membership Context

## üéØ Objetivo

Disponibilizar um **ponto √∫nico e confi√°vel** para obter o **contexto completo do usu√°rio autenticado**, incluindo:

* Identidade b√°sica do usu√°rio (Id, Email, Nome)
* Organiza√ß√µes (Sellers e Farms) √†s quais o usu√°rio pertence
* Pap√©is (Roles) exercidos em cada organiza√ß√£o

Essa feature serve como **base transversal** para todas as funcionalidades que dependem de autoriza√ß√£o, escopo organizacional ou escolha de ‚Äúorganiza√ß√£o ativa‚Äù.

---

## üìå Motiva√ß√£o

Ap√≥s a implementa√ß√£o de:

* **F1.1 ‚Äî RegisterUser**
* **F1.2 ‚Äî AuthenticateUser**

o sistema j√° possui identidade e autentica√ß√£o, por√©m **n√£o existe ainda uma forma padronizada de responder √† pergunta**:

> ‚ÄúQuem √© o usu√°rio logado e o que ele pode acessar?‚Äù

Sem essa feature:

* O front-end precisaria chamar m√∫ltiplos endpoints
* A l√≥gica de memberships seria duplicada
* F2.x (Organizations & Membership) ficaria mais dif√≠cil de consumir

A F1.3 resolve isso **antes** da explos√£o de complexidade.

---

## üß≠ Escopo

### Inclui

* Query para obter o contexto do usu√°rio autenticado
* DTOs de leitura (Read Model)
* Endpoint HTTP protegido por JWT
* Abstra√ß√£o para acesso ao usu√°rio atual (`ICurrentUser`)
* Uso exclusivo de **Read Model (Dapper)**

### N√£o inclui

* Cria√ß√£o ou altera√ß√£o de usu√°rios
* Cria√ß√£o de Sellers ou Farms
* Concess√£o ou remo√ß√£o de Memberships
* Defini√ß√£o de ‚Äúorganiza√ß√£o ativa‚Äù (isso √© concern futuro)

---

## üì¶ Contratos Aplicacionais

### Query

```csharp
public sealed record GetCurrentUserContextQuery
    : IQuery<CurrentUserContextResponse>;
```

### Response

```csharp
public sealed record CurrentUserContextResponse(
    Guid UserId,
    string Email,
    string? Name,
    IReadOnlyList<CurrentUserOrganizationDto> Organizations
);

public sealed record CurrentUserOrganizationDto(
    Guid OrganizationId,
    string OrganizationName,
    OrganizationType Type,        // Seller | Farm
    IReadOnlyList<string> Roles   // Owner | Admin | Viewer
);
```

> Todos os objetos retornados s√£o **DTOs de leitura**.
> Nenhum Aggregate √© materializado.

---

## üîê Contexto de Autentica√ß√£o

### Abstra√ß√£o

```csharp
public interface ICurrentUser
{
    Guid? UserId { get; }
    string? Email { get; }
}
```

### Origem dos dados

* `UserId` e `Email` s√£o extra√≠dos **exclusivamente dos claims do JWT**
* A API √© respons√°vel por fornecer a implementa√ß√£o concreta

---

## ‚öôÔ∏è Handler

### Responsabilidades

O `GetCurrentUserContextQueryHandler` deve:

1. Obter o `UserId` via `ICurrentUser`
2. Validar que o usu√°rio est√° autenticado
3. Consultar o Read Model para:

   * Dados b√°sicos do usu√°rio
   * Organiza√ß√µes associadas
   * Roles por organiza√ß√£o
4. Montar e retornar `CurrentUserContextResponse`

### Restri√ß√µes

* ‚ùå N√£o usar EF Core
* ‚ùå N√£o carregar Aggregates
* ‚ùå N√£o disparar eventos
* ‚úÖ Apenas Dapper / SQL / Views

---

## üåê Endpoint HTTP

```http
GET /api/auth/me
```

### Comportamento

* Requer JWT v√°lido
* Retorna `200 OK` com `CurrentUserContextResponse`
* Retorna `401 Unauthorized` se:

  * Token inv√°lido
  * Usu√°rio n√£o existir

---

## üìè Regras de Neg√≥cio

1. **Usu√°rio √© obrigat√≥rio**

   * Se n√£o houver `UserId` no contexto ‚Üí Unauthorized

2. **Organiza√ß√µes s√£o opcionais**

   * Usu√°rios rec√©m-criados podem n√£o ter Sellers/Farms
   * Nesse caso, retornar lista vazia

3. **Roles s√£o sempre contextuais**

   * N√£o existe role global
   * Toda role pertence a uma organiza√ß√£o espec√≠fica

4. **Isolamento de Bounded Context**

   * Identity fornece o usu√°rio
   * Organization & Membership fornecem v√≠nculos
   * A feature apenas **consulta**, n√£o coordena l√≥gica

---

## üö´ Fora de Escopo

* Sele√ß√£o de organiza√ß√£o ativa
* Altera√ß√£o de roles
* Cria√ß√£o de convites
* Autoriza√ß√£o baseada em policy (claims din√¢micos)

---

## ‚úÖ Checklist de Implementa√ß√£o

### Application

* [ ] Criar `GetCurrentUserContextQuery`
* [ ] Criar `CurrentUserContextResponse`
* [ ] Criar `CurrentUserOrganizationDto`
* [ ] Criar `ICurrentUser`

### Infrastructure

* [ ] Implementar `ICurrentUser` via claims do JWT
* [ ] Garantir acesso ao Read Model (Dapper)

### API

* [ ] Mapear `GET /api/auth/me`
* [ ] Proteger endpoint com JWT

### Testes

* [ ] Usu√°rio autenticado sem organiza√ß√µes
* [ ] Usu√°rio com m√∫ltiplas organiza√ß√µes
* [ ] Usu√°rio com roles distintas por organiza√ß√£o
* [ ] Token v√°lido apontando para usu√°rio inexistente

---

## üó∫Ô∏è Roadmap

```md
F1.1 ‚Äî RegisterUser
F1.2 ‚Äî AuthenticateUser
F1.3 ‚Äî Current User & Membership Context
```

---

## üß† Observa√ß√£o Arquitetural

A F1.3 **n√£o √© uma feature de neg√≥cio**, e sim uma **feature estrutural de experi√™ncia e seguran√ßa**.

Ela reduz:

* Acoplamento
* Duplica√ß√£o
* Complexidade no front-end

E prepara o terreno para:

* F2.x (Organizations & Membership)
* Policies de autoriza√ß√£o
* Multi-tenant real